# FLINT — скрипты 3ds Max для лазерной гравировки

Набор инструментов для системы подповерхностной лазерной гравировки **FLINT**. Экспорт геометрии сцены в координатный формат FLINT и оптимизация пути гравировки через сортировку точек.

## Обзор

Система FLINT гравирует 3D-изображения внутри стекла, фокусируя лазерный луч в заданных координатах. Точки необходимо отсортировать для минимизации пути лазера — это напрямую влияет на скорость гравировки и износ оборудования.

Репозиторий содержит:

- **Скрипты 3ds Max** — экспорт геометрии и запуск сортировки
- **Сортировщики точек** — консольные утилиты для оптимизации порядка точек (nearest-neighbor + локальный поиск)
- **Инструменты сборки** — компиляторы и скрипты для 16-битных DOS и 32-битных Windows целей

## Структура проекта

```
Scripts/
├── FlintExp.ms         — основная утилита 3ds Max (экспорт + сортировка)
├── Sortirovka.ms       — сортировка во вьюпорте (MAXScript, медленная)
├── cftsort.exe         — 16-битный сортировщик (положить рядом для кнопки Sort 16-bit)
└── cftsort32.exe       — 32-битный сортировщик (положить рядом для кнопки Sort 32-bit)

Utils/
├── GENESIS/            — оригинальные EXE (восстановленные)
│   ├── CFTSORT.EXE
│   └── BFTSORT.EXE
├── SRC/                — исходный код
│   ├── CFTSORT.CPP         — оригинал 16-бит (восстановлен из дизассемблирования)
│   ├── BFTSORT.CPP         — оригинал 16-бит (восстановлен из дизассемблирования)
│   ├── CFTSORT-32BIT.CPP   — улучшенный 32-бит (grid NN + or-opt)
│   ├── BFTSORT-32BIT.CPP   — улучшенный 32-бит (grid NN + or-opt)
│   ├── COMPILE.bat         — сборка всех 4 EXE
│   └── BUILD/              — результат компиляции
└── README.md

Tools/
├── BC45/               — Borland C++ 4.5 (16-битный компилятор DOS)
├── DOSBox-X/           — DOSBox-X (для 16-битной компиляции на 64-битных Windows)
└── WATCOM/             — Open Watcom C++ V2 (32-битный компилятор Win32)
```

## Быстрый старт

### 1. Собрать сортировщики

```bat
cd Utils\SRC
COMPILE.bat
```

Собирает все 4 исполняемых файла в `Utils\SRC\BUILD\`:

| Исходник | Результат | Компилятор |
|----------|-----------|------------|
| CFTSORT.CPP | CFTSORT.EXE | Borland C++ 4.5 (16-бит DOS) |
| BFTSORT.CPP | BFTSORT.EXE | Borland C++ 4.5 (16-бит DOS) |
| CFTSORT-32BIT.CPP | CFTSORT32.EXE | Open Watcom C++ (Win32 PE) |
| BFTSORT-32BIT.CPP | BFTSORT32.EXE | Open Watcom C++ (Win32 PE) |

### 2. Скопировать в папку скриптов

Скопируйте нужные EXE в `Scripts/` рядом с `FlintExp.ms`:

```bat
copy Utils\SRC\BUILD\CFTSORT.EXE   Scripts\
copy Utils\SRC\BUILD\CFTSORT32.EXE Scripts\
```

### 3. Использование в 3ds Max

1. Откройте 3ds Max
2. **MAXScript → Run Script → `Scripts\FlintExp.ms`**
3. Выберите систему координат (укажите объект или используйте по умолчанию)
4. Нажмите **Sort 16-bit** или **Sort 32-bit**
5. Укажите куда сохранить `.bft` файл
6. Скрипт экспортирует геометрию в CFT, затем запустит сортировщик

## Скрипты 3ds Max

### FlintExp.ms

Основная утилита с панелью UI:

- **Coordinate System** — выбор объекта-привязки для системы координат
- **Dir / Name** — рабочая директория (определяется автоматически) и базовое имя файла
- **Sort 16-bit** — экспорт CFT → запуск `cftsort.exe` (оригинальный 16-битный)
- **Sort 32-bit** — экспорт CFT → запуск `cftsort32.exe` (улучшенный 32-битный)
- **Import file** — импорт CFT-файла обратно в 3ds Max как вершины меша

### Sortirovka.ms

Автономный MAXScript-сортировщик — сортирует вершины выделенного меша прямо во вьюпорте алгоритмом nearest-neighbor. Полезен для мелких моделей, но очень медленный на больших наборах точек (O(N²) в MAXScript).

## Версии сортировщиков

### Оригинал (16-бит DOS)

- Исходный код восстановлен из EXE путём полного дизассемблирования
- Borland C++ 4.5 (1994), Large memory model
- Nearest-neighbor O(N²), максимум ~80K точек
- Бинарная совместимость с оригинальными EXE подтверждена

### Улучшенный (32-бит Win32)

- Win32 console PE — работает на Windows 95 — Windows 11
- Без ограничений по памяти (до 16M точек)
- Grid-accelerated nearest-neighbor O(N√N) + or-opt локальный поиск
- ~20% улучшение длины пути на реальных данных (33 944 точки)

## Форматы файлов

### CFT (текстовый)

```
flinttab
nglass=	1.506
xsize=	50
ysize=	50
zsize=	50
1:	-4888	3092	-19
2:	-4863	3075	-19
```

Целочисленные координаты через табуляцию. Заголовок: показатель преломления + размеры стекла (мм).

### BFT (бинарный)

| Смещение | Тип | Описание |
|----------|-----|----------|
| 0 | int16 | `0x6662` — сигнатура ("bf") |
| 2 | int16 | nglass × 1000 |
| 4–8 | int16×3 | xsize, ysize, zsize (×10) |
| 10 | int16 | зарезервировано |
| 12 | int16 | количество точек N |
| 14 | int16[N×3] | x, y, z на каждую точку (6 байт) |

## Алгоритм сортировки

### Метрика расстояния

```
δ = max(|dx|, |dy|) + (dz × K) / 10
```

- K = K_up при dz > 0 (штраф за движение вверх)
- K = K_down при dz ≤ 0 (бонус за движение вниз)
- Типичные значения: K_up=14, K_down=10
- Метрика **асимметрична** (ATSP)

### Улучшенный алгоритм (32-битная версия)

1. **Фаза 1** — начало с точки с минимальным Z
2. **Фаза 2** — grid-accelerated nearest-neighbor: пространственная хеш-сетка (~25 точек/ячейка), поиск расширяющимися кольцами с отсечением
3. **Фаза 3** — or-opt локальный поиск: перемещение цепочек из 1–3 точек в лучшую позицию (окно ±500, до 5 проходов). Используется or-opt вместо 2-opt, потому что метрика асимметрична — реверс сегмента изменил бы знак dz и сделал бы «дешёвые» рёбра «дорогими».

## Командная строка

```
CFTSORT[32]  source.cft  dest.bft  K_up  K_down
BFTSORT[32]  source.bft  dest.bft  K_up  K_down
```

- CFTSORT читает текстовый CFT, BFTSORT читает бинарный BFT
- Оба выдают отсортированный BFT

## Особенности сборки

`COMPILE.bat` собирает оба компилятора в одном скрипте:

- **Watcom (32-бит)**: запускается нативно на любой Windows. Использует `binnt64\` на 64-битных ОС, `binnt\` на 32-битных. Директивы линкера полностью инлайновые (внешние конфигурационные файлы не нужны).
- **Borland (16-бит)**: запускается нативно на 32-битных Windows через NTVDM. На 64-битных Windows автоматически запускает DOSBox-X.

Все тулчейны компиляторов включены в `Tools/` — системная установка не требуется.

## Лицензия

Проект предоставляется как есть для сообщества пользователей лазерной гравировки FLINT.
